<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Decentralized KYC Banking System</title>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.7.5/dist/web3.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-light: #ecf0f1;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--background-light);
        }
        header {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .panel-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .bank-list {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .log {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .bank-item {
            padding: 10px;
            margin: 5px 0;
            background: var(--background-light);
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Decentralized KYC Banking System</h1>
        <p id="metaStatus">🔌 Connect Wallet</p>
        <p id="adminStatus"></p>
    </header>

    <div class="panel-container">
        <div class="panel" id="adminPanel">
            <h2>Admin Controls</h2>
            <div class="admin-section">
                <h3>Bank Management</h3>
                <input type="text" id="bankName" placeholder="Bank Name">
                <input type="text" id="bankAddress" placeholder="Bank Address (0x...)">
                <input type="number" id="bankRegNo" placeholder="Registration Number">
                <button id="addBank">➕ Add Bank</button>
                <button id="removeBank">➖ Remove Bank</button>
            </div>
            <div class="admin-section">
                <h3>Fund Management</h3>
                <input type="text" id="fundBankAddress" placeholder="Bank Address to Fund">
                <input type="number" id="fundAmount" placeholder="Amount to Fund">
                <button id="fundBank">💰 Fund Bank</button>
            </div>
        </div>

        <div class="panel" id="bankPanel">
            <h2>Bank Operations</h2>
            <div class="bank-section">
                <button id="loginButton">🔑 Bank Login</button>
                <h3>Funds Transfer</h3>
                <input type="text" id="receiverAddress" placeholder="Receiver Address (0x...)">
                <input type="number" id="transferAmount" placeholder="Transfer Amount">
                <button id="transferButton">💸 Transfer Funds</button>
            </div>
        </div>
    </div>

    <div class="bank-list">
        <h2>Registered Banks</h2>
        <ul id="bankList"></ul>
    </div>

    <div class="log">
        <h3>Activity Log</h3>
        <div id="logOutput"></div>
    </div>

    <script>
        const contractAddress = '0xE1465a1e86cb845FB98638a62448c1F363Eb5948';
        const contractABI =[
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_bankAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_registerNumber",
				"type": "uint256"
			}
		],
		"name": "addBank",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "BankAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			}
		],
		"name": "BankRemoved",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "fundBank",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "login",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "count",
				"type": "uint256"
			}
		],
		"name": "Login",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_bankAddress",
				"type": "address"
			}
		],
		"name": "removeBank",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "transfer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "receiver",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "Transfer",
		"type": "event"
	},
	{
		"inputs": [],
		"name": "admin",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "bankAddresses",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_bank",
				"type": "address"
			}
		],
		"name": "getBankDetails",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "kycProviders",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "kycRecords",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "documentHash",
				"type": "string"
			},
			{
				"internalType": "enum DecentralizedKYC.Status",
				"name": "status",
				"type": "uint8"
			},
			{
				"internalType": "address",
				"name": "verifiedBy",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "registeredBanks",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "addr",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "registerNumber",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "balance",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "loginCount",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "exists",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]
        
        let web3, contract, account, isAdmin = false;

        // Initialize Web3
        window.addEventListener('load', async () => {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    await ethereum.request({ method: 'eth_requestAccounts' });
                    initApplication();
                } catch (error) {
                    handleError(error);
                }
            } else {
                alert('Please install MetaMask!');
            }
        });

        async function initApplication() {
            try {
                const accounts = await web3.eth.getAccounts();
                account = accounts[0];
                document.getElementById('metaStatus').textContent = `Connected: ${account.slice(0,6)}...${account.slice(-4)}`;
                
                contract = new web3.eth.Contract(contractABI, contractAddress);
                
                const adminAddress = await contract.methods.admin().call();
                isAdmin = adminAddress.toLowerCase() === account.toLowerCase();
                document.getElementById('adminStatus').textContent = isAdmin ? 
                    '🛡️ Admin Privileges Active' : '⚠️ Regular User Account';
                
                document.getElementById('adminPanel').style.display = isAdmin ? 'block' : 'none';
                await loadBanks();
                setupEventListeners();
            } catch (error) {
                handleError(error);
            }
        }

        async function loadBanks() {
            try {
                const bankList = document.getElementById('bankList');
                bankList.innerHTML = '';
                let addresses = [];
                
                // Retrieve all bank addresses
                for (let i = 0; ; i++) {
                    try {
                        const address = await contract.methods.bankAddresses(i).call();
                        addresses.push(address);
                    } catch {
                        break;
                    }
                }

                // Populate bank details
                for (const addr of addresses) {
                    const details = await contract.methods.getBankDetails(addr).call();
                    const li = document.createElement('li');
                    li.className = 'bank-item';
                    li.innerHTML = `
                        <strong>${details[0]}</strong><br>
                        Address: ${addr}<br>
                        Balance: ${details[3]}<br>
                        Logins: ${details[4]}
                    `;
                    bankList.appendChild(li);
                }
                log(`Loaded ${addresses.length} banks`);
            } catch (error) {
                handleError(error);
            }
        }

        function setupEventListeners() {
            // Admin functions
            document.getElementById('addBank').addEventListener('click', async () => {
                const name = document.getElementById('bankName').value;
                const address = document.getElementById('bankAddress').value;
                const regNo = document.getElementById('bankRegNo').value;
                
                try {
                    await contract.methods.addBank(name, address, regNo)
                        .send({ from: account, gas: 300000 });
                    log(`Bank added: ${name} (${address})`);
                    await loadBanks();
                } catch (error) {
                    handleError(error);
                }
            });

            document.getElementById('fundBank').addEventListener('click', async () => {
                const bankAddress = document.getElementById('fundBankAddress').value;
                const amount = document.getElementById('fundAmount').value;
                
                try {
                    await contract.methods.fundBank(bankAddress, amount)
                        .send({ from: account, gas: 300000 });
                    log(`Funded ${amount} to ${bankAddress}`);
                    await loadBanks();
                } catch (error) {
                    handleError(error);
                }
            });

            // Bank functions
            document.getElementById('transferButton').addEventListener('click', async () => {
                const receiver = document.getElementById('receiverAddress').value;
                const amount = document.getElementById('transferAmount').value;

                try {
                    // Validate receiver
                    const receiverDetails = await contract.methods.getBankDetails(receiver).call();
                    if (!receiverDetails.exists) {
                        throw new Error('Receiver not a registered bank');
                    }

                    await contract.methods.transfer(receiver, amount)
                        .send({ from: account, gas: 300000 });
                    log(`Transferred ${amount} to ${receiver}`);
                    await loadBanks();
                } catch (error) {
                    handleError(error);
                }
            });

            document.getElementById('loginButton').addEventListener('click', async () => {
                try {
                    await contract.methods.login()
                        .send({ from: account, gas: 300000 });
                    log(`Login recorded for ${account}`);
                    await loadBanks();
                } catch (error) {
                    handleError(error);
                }
            });
        }

        function log(message) {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `[${timestamp}] ${message}<br>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function handleError(error) {
            console.error(error);
            log(`❌ Error: ${error.message || error}`);
        }
    </script>
</body>
</html>
