<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KYC DApp</title>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.7.5/dist/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f9f9f9;
        }
        header {
            padding: 1rem;
            background: #222;
            color: white;
            text-align: center;
        }
        #container {
            display: flex;
        }
        #sidebar {
            width: 200px;
            background: #333;
            color: white;
            padding: 1rem;
        }
        #main {
            flex: 1;
            padding: 1rem;
        }
        input, button {
            margin: 0.5rem 0;
            padding: 0.5rem;
            width: 100%;
        }
        .log {
            background: #eee;
            padding: 0.5rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header>
        <h1>KYC DAPP</h1>
        <p id="metaStatus">Connect MetaMask</p>
        <p id="adminStatus"></p>
    </header>

    <div id="container">
        <div id="sidebar">
            <h3>Admin Panel</h3>
        </div>

        <div id="main">
            <label>Bank Name:</label>
            <input type="text" id="bankName" placeholder="e.g., Canara">

            <label>Bank Address:</label>
            <input type="text" id="bankAddress" placeholder="0x...">

            <label>Registration No:</label>
            <input type="number" id="bankRegNo" placeholder="e.g., 1234">

            <button id="addBank">Add Bank</button>
            <button id="removeBank">Remove Bank</button>

            <h3>Registered Banks</h3>
            <ul id="bankList"></ul>

            <h3>Logs</h3>
            <div class="log" id="logOutput"></div>
        </div>
    </div>

    <script>
        const contractAddress = '0x965A007e33A3E84f6276EF201FEA9C3Bed3e4127'; // replace with your contract address
        const contractABI = [
		
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_bankAddress",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_regNumber",
				"type": "string"
			}
		],
		"name": "addBank",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_customerAddress",
				"type": "address"
			},
			{
				"internalType": "string",
				"name": "_name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_data",
				"type": "string"
			}
		],
		"name": "addCustomer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_customerAddress",
				"type": "address"
			}
		],
		"name": "approveKyc",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "BankAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			}
		],
		"name": "BankRemoved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "upvote",
				"type": "bool"
			}
		],
		"name": "BankVoted",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "customerAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "name",
				"type": "string"
			}
		],
		"name": "CustomerAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "customerAddress",
				"type": "address"
			}
		],
		"name": "KYCRequestAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "customerAddress",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "status",
				"type": "bool"
			}
		],
		"name": "KYCStatusUpdated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_bankAddress",
				"type": "address"
			}
		],
		"name": "removeBank",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_customerAddress",
				"type": "address"
			}
		],
		"name": "requestKyc",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_bankAddress",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "_upvote",
				"type": "bool"
			}
		],
		"name": "voteBank",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "admin",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "banks",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "kycCount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "rating",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "regNumber",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "exists",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "customers",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "data",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "customerAddress",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "kycStatus",
				"type": "bool"
			},
			{
				"internalType": "bool",
				"name": "exists",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "downvotes",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getAllBanks",
		"outputs": [
			{
				"internalType": "address[]",
				"name": "",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_bankAddress",
				"type": "address"
			}
		],
		"name": "getBankDetails",
		"outputs": [
			{
				"internalType": "string",
				"name": "name",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "bankAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "kycCount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "rating",
				"type": "uint256"
			},
			{
				"internalType": "string",
				"name": "regNumber",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_customerAddress",
				"type": "address"
			}
		],
		"name": "getCustomerData",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_address",
				"type": "address"
			}
		],
		"name": "isBank",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_address",
				"type": "address"
			}
		],
		"name": "isCustomer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "kycRequests",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "upvotes",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
        let web3;
        let contract;
        let account;

        window.addEventListener('load', async () => {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                await ethereum.request({ method: 'eth_requestAccounts' });
                const accounts = await web3.eth.getAccounts();
                account = accounts[0];
                document.getElementById('metaStatus').textContent = `Connected: ${account}`;

                contract = new web3.eth.Contract(contractABI, contractAddress);

                const adminAddress = await contract.methods.admin().call();
                console.log("Admin is:", adminAddress);
                console.log("Connected Account:", account);

                if (adminAddress.toLowerCase() === account.toLowerCase()) {
                    document.getElementById('adminStatus').textContent = "‚úÖ You are the admin.";
                } else {
                    document.getElementById('adminStatus').textContent = "‚õî You are NOT the admin.";
                }

                await loadBankList();
            } else {
                alert("Please install MetaMask to use this DApp.");
            }
        });

		async function fetchBanks() {
    try {
        const addresses = await contract.methods.getAllBanks().call();
        const bankList = document.getElementById('bankList');
        bankList.innerHTML = "";

        for (const addr of addresses) {
            const details = await contract.methods.getBankDetails(addr).call();
            const item = document.createElement('li');
            item .textContent = `${details.name} (${details.bankAddress}) - Reg: ${details.regNumber}, KYC Count: ${details.kycCount}, Rating: ${details.rating}`;
            bankList.appendChild(item);
        }

        log("üìã Fetched bank list.");
    } catch (err) {
        log(`‚ùå Error fetching banks: ${err.message}`);
    }
}
if (adminAddress.toLowerCase() === account.toLowerCase()) {
    document.getElementById('adminStatus').textContent = "‚úÖ You are the admin.";
    fetchBanks(); // ‚úÖ load initial bank list
}



        async function loadBankList() {
    try {
        const banks = await contract.methods.getAllBanks().call();
        const bankListEl = document.getElementById('bankList');
        bankListEl.innerHTML = '';

        for (let i = 0; i < banks.length; i++) {
            const addr = banks[i];
            const bankDetails = await contract.methods.registeredBanks(addr).call();

            const li = document.createElement('li');
            li.textContent = `üè¶ ${bankDetails.name} (Reg#: ${bankDetails.registerNumber}, Address: ${addr})`;
            bankListEl.appendChild(li);
        }

        log(`‚úÖ Bank list updated. Total banks: ${banks.length}`);
    } catch (err) {
        log(`‚ùå Failed to fetch bank list: ${err.message}`);
    }
}

document.getElementById('addBank').addEventListener('click', async () => {
    const name = document.getElementById('bankName').value;
    const address = document.getElementById('bankAddress').value;
    const reg = document.getElementById('bankRegNo').value;

    try {
        await contract.methods.addBank(address, name, reg).send({ from: account });
        log(`‚úÖ Bank added: ${name} (${address})`);
        fetchBanks(); // refresh the list
    } catch (err) {
        log(`‚ùå Error adding bank: ${err.message}`);
    }
});

document.getElementById('removeBank').addEventListener('click', async () => {
    const address = document.getElementById('bankAddress').value;

    try {
        await contract.methods.removeBank(address).send({ from: account });
        log(`‚ùå Bank removed: ${address}`);
        fetchBanks(); // refresh the list
    } catch (err) {
        log(`‚ùå Error removing bank: ${err.message}`);
    }
});



function log(message) {
    const logOutput = document.getElementById('logOutput');
    const time = new Date().toLocaleTimeString();
    logOutput.textContent += `[${time}] ${message}\n`;
    logOutput.scrollTop = logOutput.scrollHeight;
}

    </script>
</body>
</html>
